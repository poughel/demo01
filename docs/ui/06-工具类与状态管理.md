# DataSophon UI 模块 - 工具类与状态管理分析

## 一、工具类概述

DataSophon UI 包含 **14 个工具类文件**，提供了路由管理、权限控制、主题切换、国际化等核心功能的支持。

### 工具类文件结构

```
src/utils/
├── axios-interceptors.js      # Axios 拦截器
├── authority-utils.js         # 权限工具
├── baseUtils.js               # 基础工具
├── changeRouter.js            # 路由切换
├── colors.js                  # 颜色工具
├── formatter.js               # 格式化工具
├── i18n.js                    # 国际化工具
├── index.js                   # 工具入口
├── Objects.js                 # 对象工具
├── request.js                 # 请求工具
├── routerUtil.js              # 路由工具
├── themeUtil.js               # 主题工具
├── theme-color-replacer-extend.js  # 主题色扩展
└── util.js                    # 通用工具
```

## 二、核心工具类详解

### 2.1 routerUtil.js - 路由工具

#### 功能概述
提供动态路由加载、路由格式化、权限处理等功能。

#### 核心方法

##### 1. 解析路由配置
```javascript
/**
 * 解析路由配置
 * @param routesConfig 路由配置数组
 * @param routerMap 路由映射表
 * @returns {Route[]} 解析后的路由数组
 */
function parseRoutes(routesConfig, routerMap) {
  let routes = []
  routesConfig.forEach(item => {
    // 从 routerMap 获取注册的路由
    let router = routerMap[item.router || item]
    
    // 构建路由对象
    const route = {
      path: item.path || router.path,
      name: item.name || router.name,
      component: router.component,
      redirect: item.redirect,
      meta: {
        authority: item.authority || router.authority || '*',
        icon: item.icon || router.icon,
        ...item.meta
      }
    }
    
    // 递归处理子路由
    if (item.children && item.children.length > 0) {
      route.children = parseRoutes(item.children, routerMap)
    }
    
    routes.push(route)
  })
  return routes
}
```

##### 2. 加载路由
```javascript
/**
 * 加载路由配置
 * @param routesConfig 路由配置
 */
function loadRoutes(routesConfig) {
  const {store, router, i18n} = appOptions
  
  // 保存配置
  if (routesConfig) {
    store.commit('account/setRoutesConfig', routesConfig)
  }
  
  // 解析路由
  const routes = parseRoutes(routesConfig, routerMap)
  
  // 格式化路由
  formatRoutes(routes)
  
  // 动态添加路由
  router.addRoutes(routes)
  
  // 提取国际化数据
  mergeI18nFromRoutes(i18n, routes)
  
  // 初始化菜单
  const menuRoutes = routes.find(r => r.path === '/').children
  store.commit('setting/setMenuData', menuRoutes)
}
```

##### 3. 格式化权限
```javascript
/**
 * 格式化路由权限配置
 * @param routes 路由数组
 * @param pAuthorities 父级权限
 */
function formatAuthority(routes, pAuthorities = []) {
  routes.forEach(route => {
    const meta = route.meta || {}
    let authority = {}
    
    // 处理权限配置
    if (!meta.authority) {
      // 继承父级权限
      authority = pAuthorities[pAuthorities.length - 1] || {permission: '*'}
    } else if (typeof meta.authority === 'string') {
      authority.permission = meta.authority
    } else if (typeof meta.authority === 'object') {
      authority = meta.authority
    }
    
    route.meta = {...meta, authority}
    route.meta.pAuthorities = pAuthorities
    
    // 递归处理子路由
    if (route.children) {
      formatAuthority(route.children, [...pAuthorities, authority])
    }
  })
}
```

### 2.2 authority-utils.js - 权限工具

#### 核心方法

##### 1. 权限检查
```javascript
/**
 * 检查用户是否有权限访问路由
 * @param route 路由对象
 * @param permissions 用户权限列表
 * @param roles 用户角色列表
 * @returns {boolean}
 */
export function hasAuthority(route, permissions, roles) {
  const authority = route.meta.authority
  
  // 没有配置权限，默认允许
  if (!authority) {
    return true
  }
  
  // 通配符，所有人可访问
  if (authority === '*' || authority.permission === '*') {
    return true
  }
  
  // 检查权限
  if (authority.permission) {
    const requiredPermissions = Array.isArray(authority.permission)
      ? authority.permission
      : [authority.permission]
    
    return requiredPermissions.some(p => permissions.includes(p))
  }
  
  // 检查角色
  if (authority.role) {
    const requiredRoles = Array.isArray(authority.role)
      ? authority.role
      : [authority.role]
    
    return requiredRoles.some(r => roles.includes(r))
  }
  
  return false
}
```

##### 2. 菜单过滤
```javascript
/**
 * 根据权限过滤菜单
 * @param menuData 菜单数据
 * @param permissions 用户权限
 * @param roles 用户角色
 * @returns {Array} 过滤后的菜单
 */
export function filterMenu(menuData, permissions, roles) {
  return menuData.filter(item => {
    if (hasAuthority(item, permissions, roles)) {
      if (item.children && item.children.length > 0) {
        item.children = filterMenu(item.children, permissions, roles)
      }
      return true
    }
    return false
  })
}
```

### 2.3 themeUtil.js - 主题工具

#### 核心方法

##### 1. 获取主题色
```javascript
/**
 * 获取主题色配置
 * @returns {Array} 主题色数组
 */
export function getThemeColors() {
  return [
    '#1890ff',  // 主色
    '#096dd9',  // 深主色
    '#40a9ff',  // 浅主色
    '#e6f7ff',  // 极浅主色
  ]
}
```

##### 2. 修改 Less 变量
```javascript
/**
 * 修改 Ant Design 的 Less 变量
 * @returns {Object} Less 变量配置
 */
export function modifyVars() {
  return {
    'primary-color': '#1890ff',
    'link-color': '#1890ff',
    'success-color': '#52c41a',
    'warning-color': '#faad14',
    'error-color': '#f5222d',
    'font-size-base': '14px',
    'heading-color': 'rgba(0, 0, 0, 0.85)',
    'text-color': 'rgba(0, 0, 0, 0.65)',
    'text-color-secondary': 'rgba(0, 0, 0, 0.45)',
    'disabled-color': 'rgba(0, 0, 0, 0.25)',
    'border-radius-base': '2px',
    'border-color-base': '#d9d9d9',
    'box-shadow-base': '0 2px 8px rgba(0, 0, 0, 0.15)'
  }
}
```

##### 3. 切换主题
```javascript
/**
 * 切换主题色
 * @param color 新主题色
 */
export function changeTheme(color) {
  // 使用 webpack-theme-color-replacer 插件
  const options = {
    newColors: getThemeColors(color),
    changeUrl(cssUrl) {
      return `/${cssUrl}`
    }
  }
  
  return client.changer.changeColor(options)
}
```

### 2.4 i18n.js - 国际化工具

#### 核心方法

##### 1. 初始化 i18n
```javascript
/**
 * 初始化 i18n
 * @param lang 默认语言
 * @param fallback 回退语言
 * @returns {VueI18n} i18n 实例
 */
export function initI18n(lang = 'CN', fallback = 'US') {
  // 加载语言包
  const messages = {
    'CN': require('@/locales/zh-CN').default,
    'US': require('@/locales/en-US').default
  }
  
  // 创建 i18n 实例
  return new VueI18n({
    locale: lang,
    fallbackLocale: fallback,
    messages
  })
}
```

##### 2. 从路由提取国际化
```javascript
/**
 * 从路由中提取国际化数据
 * @param i18n i18n 实例
 * @param routes 路由配置
 */
export function mergeI18nFromRoutes(i18n, routes) {
  routes.forEach(route => {
    const key = getI18nKey(route.path)
    
    // 添加路由标题的国际化
    if (route.meta && route.meta.title) {
      i18n.mergeLocaleMessage('CN', {[key]: route.meta.title})
      i18n.mergeLocaleMessage('US', {[key]: route.meta.titleEn || route.meta.title})
    }
    
    // 递归处理子路由
    if (route.children) {
      mergeI18nFromRoutes(i18n, route.children)
    }
  })
}
```

### 2.5 formatter.js - 格式化工具

#### 核心方法

##### 1. 日期格式化
```javascript
/**
 * 格式化日期
 * @param date 日期对象或时间戳
 * @param format 格式字符串
 * @returns {String} 格式化后的日期字符串
 */
export function formatDate(date, format = 'YYYY-MM-DD HH:mm:ss') {
  if (!date) return ''
  
  const d = new Date(date)
  const year = d.getFullYear()
  const month = String(d.getMonth() + 1).padStart(2, '0')
  const day = String(d.getDate()).padStart(2, '0')
  const hour = String(d.getHours()).padStart(2, '0')
  const minute = String(d.getMinutes()).padStart(2, '0')
  const second = String(d.getSeconds()).padStart(2, '0')
  
  return format
    .replace('YYYY', year)
    .replace('MM', month)
    .replace('DD', day)
    .replace('HH', hour)
    .replace('mm', minute)
    .replace('ss', second)
}
```

##### 2. 文件大小格式化
```javascript
/**
 * 格式化文件大小
 * @param bytes 字节数
 * @returns {String} 格式化后的大小
 */
export function formatFileSize(bytes) {
  if (bytes === 0) return '0 B'
  
  const k = 1024
  const sizes = ['B', 'KB', 'MB', 'GB', 'TB']
  const i = Math.floor(Math.log(bytes) / Math.log(k))
  
  return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i]
}
```

##### 3. 数字格式化
```javascript
/**
 * 格式化数字（千分位）
 * @param number 数字
 * @returns {String} 格式化后的数字
 */
export function formatNumber(number) {
  return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',')
}
```

### 2.6 util.js - 通用工具

#### 核心方法

##### 1. 深拷贝
```javascript
/**
 * 深拷贝对象
 * @param obj 源对象
 * @returns {Object} 拷贝后的对象
 */
export function deepClone(obj) {
  if (obj === null || typeof obj !== 'object') {
    return obj
  }
  
  if (obj instanceof Date) {
    return new Date(obj.getTime())
  }
  
  if (obj instanceof Array) {
    return obj.map(item => deepClone(item))
  }
  
  if (obj instanceof Object) {
    const cloned = {}
    for (let key in obj) {
      if (obj.hasOwnProperty(key)) {
        cloned[key] = deepClone(obj[key])
      }
    }
    return cloned
  }
}
```

##### 2. 防抖
```javascript
/**
 * 防抖函数
 * @param fn 要防抖的函数
 * @param delay 延迟时间（ms）
 * @returns {Function} 防抖后的函数
 */
export function debounce(fn, delay = 300) {
  let timer = null
  return function(...args) {
    if (timer) clearTimeout(timer)
    timer = setTimeout(() => {
      fn.apply(this, args)
    }, delay)
  }
}
```

##### 3. 节流
```javascript
/**
 * 节流函数
 * @param fn 要节流的函数
 * @param delay 间隔时间（ms）
 * @returns {Function} 节流后的函数
 */
export function throttle(fn, delay = 300) {
  let lastTime = 0
  return function(...args) {
    const now = Date.now()
    if (now - lastTime >= delay) {
      fn.apply(this, args)
      lastTime = now
    }
  }
}
```

## 三、状态管理 (Vuex)

### 3.1 Store 结构

```
src/store/
├── index.js              # Store 入口
└── modules/              # 状态模块
    ├── account.js        # 账户模块
    └── setting.js        # 设置模块
```

### 3.2 account 模块

#### State
```javascript
const state = {
  user: null,               // 用户信息
  permissions: [],          // 权限列表
  roles: [],                // 角色列表
  routesConfig: []          // 路由配置
}
```

#### Mutations
```javascript
const mutations = {
  setUser(state, user) {
    state.user = user
  },
  setPermissions(state, permissions) {
    state.permissions = permissions
  },
  setRoles(state, roles) {
    state.roles = roles
  },
  setRoutesConfig(state, routesConfig) {
    state.routesConfig = routesConfig
  }
}
```

#### Actions
```javascript
const actions = {
  /**
   * 登录
   */
  async login({commit}, {username, password}) {
    const data = await api.login(username, password)
    commit('setUser', data.user)
    commit('setPermissions', data.permissions)
    commit('setRoles', data.roles)
    setAuthorization(data)
  },
  
  /**
   * 退出登录
   */
  logout({commit}) {
    commit('setUser', null)
    commit('setPermissions', [])
    commit('setRoles', [])
    removeAuthorization()
  },
  
  /**
   * 获取用户信息
   */
  async getUserInfo({commit}) {
    const data = await api.getUserInfo()
    commit('setUser', data.user)
    commit('setPermissions', data.permissions)
    commit('setRoles', data.roles)
  }
}
```

#### Getters
```javascript
const getters = {
  user: state => state.user,
  permissions: state => state.permissions,
  roles: state => state.roles,
  routesConfig: state => state.routesConfig
}
```

### 3.3 setting 模块

#### State
```javascript
const state = {
  theme: 'dark',            // 主题
  layout: 'side',           // 布局模式
  menuData: [],             // 菜单数据
  isCluster: '',            // 集群模式
  clusterId: null,          // 当前集群ID
  lang: 'CN'                // 语言
}
```

#### Mutations
```javascript
const mutations = {
  setTheme(state, theme) {
    state.theme = theme
  },
  setLayout(state, layout) {
    state.layout = layout
  },
  setMenuData(state, menuData) {
    state.menuData = menuData
  },
  setIsCluster(state, isCluster) {
    state.isCluster = isCluster
    localStorage.setItem('isCluster', isCluster)
  },
  setClusterId(state, clusterId) {
    state.clusterId = clusterId
    localStorage.setItem('clusterId', clusterId)
  },
  setLang(state, lang) {
    state.lang = lang
  }
}
```

#### Actions
```javascript
const actions = {
  /**
   * 切换主题
   */
  async changeTheme({commit}, theme) {
    commit('setTheme', theme)
    await changeThemeColor(theme)
  },
  
  /**
   * 切换语言
   */
  changeLang({commit}, lang) {
    commit('setLang', lang)
    i18n.locale = lang
  },
  
  /**
   * 获取运行中的集群列表
   */
  async getRunningClusterList({commit}) {
    const data = await api.getRunningClusterList()
    // 生成服务菜单
    const menuData = generateServiceMenu(data)
    commit('setMenuData', menuData)
  }
}
```

## 四、工具类使用示例

### 4.1 路由工具使用

```javascript
// 加载动态路由
import {loadRoutes} from '@/utils/routerUtil'

loadRoutes(routesConfig)

// 格式化路由
import {formatRoutes} from '@/utils/routerUtil'

formatRoutes(routes)
```

### 4.2 权限检查

```javascript
// 在组件中检查权限
import {hasAuthority} from '@/utils/authority-utils'

computed: {
  canEdit() {
    return hasAuthority(
      {meta: {authority: 'cluster:edit'}},
      this.$store.getters['account/permissions'],
      this.$store.getters['account/roles']
    )
  }
}
```

### 4.3 主题切换

```javascript
// 切换主题色
import {changeTheme} from '@/utils/themeUtil'

methods: {
  async handleThemeChange(color) {
    await changeTheme(color)
    this.$message.success('主题已切换')
  }
}
```

### 4.4 格式化使用

```javascript
import {formatDate, formatFileSize, formatNumber} from '@/utils/formatter'

computed: {
  formattedDate() {
    return formatDate(this.createTime)
  },
  formattedSize() {
    return formatFileSize(this.fileSize)
  },
  formattedCount() {
    return formatNumber(this.count)
  }
}
```

### 4.5 Vuex 使用

```javascript
import {mapState, mapGetters, mapMutations, mapActions} from 'vuex'

export default {
  computed: {
    // State
    ...mapState('account', ['user']),
    
    // Getters
    ...mapGetters('account', ['permissions', 'roles'])
  },
  methods: {
    // Mutations
    ...mapMutations('setting', ['setTheme']),
    
    // Actions
    ...mapActions('account', ['login', 'logout'])
  }
}
```

## 五、最佳实践

### 5.1 工具函数命名

```javascript
// ✅ 推荐：动词开头，清晰明确
formatDate()
parseRoutes()
hasAuthority()
loadRoutes()

// ❌ 避免：名词或缩写
date()
routes()
auth()
load()
```

### 5.2 工具函数设计

```javascript
// ✅ 推荐：纯函数，无副作用
export function formatDate(date, format) {
  // 不修改传入的参数
  // 不依赖外部状态
  return formattedDate
}

// ❌ 避免：有副作用
export function formatDate(date, format) {
  date.setHours(0, 0, 0, 0)  // 修改了参数
  window.lastFormatted = date  // 依赖外部状态
  return formattedDate
}
```

### 5.3 Vuex 模块化

```javascript
// ✅ 推荐：模块化管理
store/
  modules/
    account.js
    setting.js
    cluster.js
  index.js

// ❌ 避免：所有状态放在一起
store/
  index.js  // 所有 state、mutations、actions
```

## 六、总结

### 工具类统计

| 类别 | 文件数 | 核心功能 |
|------|-------|---------|
| 路由工具 | 2 | 动态路由、权限格式化 |
| 权限工具 | 1 | 权限检查、菜单过滤 |
| 主题工具 | 2 | 主题切换、颜色配置 |
| 国际化 | 1 | 多语言支持 |
| 格式化 | 1 | 日期、文件大小、数字 |
| 通用工具 | 1 | 深拷贝、防抖、节流 |
| 请求工具 | 2 | 认证管理、拦截器 |
| 其他工具 | 4 | 对象操作、路由切换等 |
| **总计** | **14** | **所有工具功能** |

### 状态管理

| 模块 | 功能 |
|------|------|
| account | 用户信息、权限、角色 |
| setting | 主题、布局、菜单、语言 |

### 技术特点

1. **模块化**: 工具类按功能划分，职责清晰
2. **纯函数**: 工具函数无副作用，可测试性强
3. **可复用**: 提供通用的工具方法
4. **状态管理**: Vuex 模块化，易于维护
5. **类型安全**: 完善的参数验证和错误处理

---

**文档状态**: ✅ 已完成  
**工具类数量**: 14 个  
**Vuex 模块数**: 2 个  
**最后更新**: 2025-11-16
