# 告警实体类详解 - Domain 层完整分析

## 一、告警实体类概述

### 1.1 模块定位

告警实体类是 DataSophon 告警管理系统的数据模型层，定义了告警组、告警规则、告警历史和告警指标等核心实体。这些实体类位于 Domain 层，通过 MyBatis-Plus 与数据库交互。

**模块路径**: `datasophon-domain/src/main/java/com/datasophon/domain/entity/`

### 1.2 告警相关实体类

```
告警实体模块
├── AlertGroupEntity                     # 告警组实体
├── ClusterAlertQuota                    # 告警指标实体
├── ClusterAlertRule                     # 告警规则实体
├── ClusterAlertHistory                  # 告警历史实体
├── ClusterAlertGroupMap                 # 集群告警组映射实体
└── ClusterAlertExpression               # 告警表达式实体（可选）
```

### 1.3 实体关系图

```
┌─────────────────────┐
│   ClusterInfoEntity │
│      集群信息        │
└──────────┬──────────┘
           │ 1
           │
           │ N
┌──────────▼──────────┐         ┌─────────────────────┐
│  AlertGroupEntity   │◄────────┤ ClusterAlertGroupMap│
│     告警组实体       │  N:N    │  集群告警组映射      │
└──────────┬──────────┘         └─────────────────────┘
           │ 1
           │
           │ N
┌──────────▼──────────┐
│ ClusterAlertQuota   │
│   告警指标实体       │
└──────────┬──────────┘
           │ 1
           │
           │ N
┌──────────▼──────────┐
│ClusterAlertHistory  │
│   告警历史实体       │
└─────────────────────┘
           │ 1
           │
           │ 1
┌──────────▼──────────┐
│ ClusterAlertRule    │
│   告警规则实体       │
└─────────────────────┘
```

## 二、AlertGroupEntity - 告警组实体

### 2.1 类定义

**文件位置**: `datasophon-domain/src/main/java/com/datasophon/domain/entity/AlertGroupEntity.java`

```java
@Data
@TableName("t_ddh_alert_group")
@ApiModel(value = "AlertGroupEntity", description = "告警组实体")
public class AlertGroupEntity implements Serializable {
    
    private static final long serialVersionUID = 1L;
    
    /**
     * 主键ID
     */
    @TableId(value = "id", type = IdType.AUTO)
    @ApiModelProperty(value = "主键ID")
    private Integer id;
    
    /**
     * 告警组名称
     */
    @ApiModelProperty(value = "告警组名称", required = true)
    private String alertGroupName;
    
    /**
     * 告警组类别
     * SERVICE: 服务告警
     * HOST: 主机告警
     * DATABASE: 数据库告警
     * NETWORK: 网络告警
     * CUSTOM: 自定义告警
     */
    @ApiModelProperty(value = "告警组类别")
    private String alertGroupCategory;
    
    /**
     * 集群ID
     */
    @ApiModelProperty(value = "集群ID", required = true)
    private Integer clusterId;
    
    /**
     * 告警级别
     * INFO: 提示
     * WARNING: 警告
     * ERROR: 错误
     * CRITICAL: 严重
     */
    @ApiModelProperty(value = "告警级别")
    private String alertLevel;
    
    /**
     * 通知用户ID列表（逗号分隔）
     */
    @ApiModelProperty(value = "通知用户ID列表")
    private String noticeUserIds;
    
    /**
     * 通知用户组ID列表（逗号分隔）
     */
    @ApiModelProperty(value = "通知用户组ID列表")
    private String noticeGroupUserIds;
    
    /**
     * 通知方式（逗号分隔）
     * EMAIL: 邮件
     * DINGDING: 钉钉
     * WECHAT: 企业微信
     * SMS: 短信
     * WEBHOOK: 自定义Webhook
     * FEISHU: 飞书
     */
    @ApiModelProperty(value = "通知方式")
    private String noticeWay;
    
    /**
     * 邮件配置（JSON格式）
     */
    @ApiModelProperty(value = "邮件配置")
    private String emailConfig;
    
    /**
     * 钉钉配置（JSON格式）
     */
    @ApiModelProperty(value = "钉钉配置")
    private String dingdingConfig;
    
    /**
     * 企业微信配置（JSON格式）
     */
    @ApiModelProperty(value = "企业微信配置")
    private String wechatConfig;
    
    /**
     * 短信配置（JSON格式）
     */
    @ApiModelProperty(value = "短信配置")
    private String smsConfig;
    
    /**
     * Webhook配置（JSON格式）
     */
    @ApiModelProperty(value = "Webhook配置")
    private String webhookConfig;
    
    /**
     * 飞书配置（JSON格式）
     */
    @ApiModelProperty(value = "飞书配置")
    private String feishuConfig;
    
    /**
     * 创建时间
     */
    @TableField(fill = FieldFill.INSERT)
    @ApiModelProperty(value = "创建时间")
    private Date createTime;
    
    /**
     * 更新时间
     */
    @TableField(fill = FieldFill.INSERT_UPDATE)
    @ApiModelProperty(value = "更新时间")
    private Date updateTime;
    
    /**
     * 通知用户名称列表（非数据库字段）
     */
    @TableField(exist = false)
    @ApiModelProperty(value = "通知用户名称列表")
    private String noticeUserNames;
    
    /**
     * 关联的告警指标数量（非数据库字段）
     */
    @TableField(exist = false)
    @ApiModelProperty(value = "关联的告警指标数量")
    private Long alertQuotaCount;
}
```

### 2.2 字段说明

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | Integer | 主键ID | 自增、非空 |
| alertGroupName | String | 告警组名称 | 非空、唯一（同集群内） |
| alertGroupCategory | String | 告警组类别 | 枚举值 |
| clusterId | Integer | 集群ID | 非空、外键 |
| alertLevel | String | 告警级别 | 枚举值 |
| noticeUserIds | String | 通知用户ID | 逗号分隔 |
| noticeGroupUserIds | String | 通知用户组ID | 逗号分隔 |
| noticeWay | String | 通知方式 | 非空、逗号分隔 |
| emailConfig | String | 邮件配置 | JSON格式 |
| dingdingConfig | String | 钉钉配置 | JSON格式 |
| wechatConfig | String | 企业微信配置 | JSON格式 |
| smsConfig | String | 短信配置 | JSON格式 |
| webhookConfig | String | Webhook配置 | JSON格式 |
| feishuConfig | String | 飞书配置 | JSON格式 |
| createTime | Date | 创建时间 | 自动填充 |
| updateTime | Date | 更新时间 | 自动更新 |

### 2.3 通知配置格式

#### 邮件配置示例

```json
{
  "host": "smtp.example.com",
  "port": 465,
  "ssl": true,
  "username": "alert@example.com",
  "password": "encrypted_password",
  "from": "DataSophon Alert <alert@example.com>",
  "to": "admin@example.com,ops@example.com",
  "subject": "[DataSophon] 告警通知",
  "timeout": 10000
}
```

#### 钉钉配置示例

```json
{
  "webhook": "https://oapi.dingtalk.com/robot/send?access_token=xxx",
  "secret": "SECxxx",
  "atMobiles": ["13800138000", "13900139000"],
  "atUserIds": ["user1", "user2"],
  "isAtAll": false,
  "messageType": "markdown"
}
```

#### 企业微信配置示例

```json
{
  "webhook": "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx",
  "mentionedList": ["@all"],
  "mentionedMobileList": ["13800138000"]
}
```

#### 飞书配置示例

```json
{
  "webhook": "https://open.feishu.cn/open-apis/bot/v2/hook/xxx",
  "secret": "xxx",
  "atOpenIds": ["ou_xxx", "ou_yyy"],
  "atAll": false
}
```

#### Webhook配置示例

```json
{
  "url": "https://your-api.com/alert/webhook",
  "method": "POST",
  "headers": {
    "Content-Type": "application/json",
    "Authorization": "Bearer your_token",
    "X-Custom-Header": "value"
  },
  "bodyTemplate": {
    "alertId": "${alertId}",
    "clusterId": "${clusterId}",
    "clusterName": "${clusterName}",
    "serviceName": "${serviceName}",
    "alertLevel": "${alertLevel}",
    "alertMessage": "${alertMessage}",
    "alertTime": "${alertTime}",
    "hostname": "${hostname}"
  },
  "timeout": 5000,
  "retryCount": 3
}
```

### 2.4 枚举类型

#### AlertGroupCategory - 告警组类别

```java
public enum AlertGroupCategory {
    /**
     * 服务告警
     */
    SERVICE("SERVICE", "服务告警"),
    
    /**
     * 主机告警
     */
    HOST("HOST", "主机告警"),
    
    /**
     * 数据库告警
     */
    DATABASE("DATABASE", "数据库告警"),
    
    /**
     * 网络告警
     */
    NETWORK("NETWORK", "网络告警"),
    
    /**
     * 自定义告警
     */
    CUSTOM("CUSTOM", "自定义告警");
    
    private String code;
    private String desc;
    
    AlertGroupCategory(String code, String desc) {
        this.code = code;
        this.desc = desc;
    }
}
```

#### AlertLevel - 告警级别

```java
public enum AlertLevel {
    /**
     * 提示级别
     */
    INFO("INFO", "提示", 1),
    
    /**
     * 警告级别
     */
    WARNING("WARNING", "警告", 2),
    
    /**
     * 错误级别
     */
    ERROR("ERROR", "错误", 3),
    
    /**
     * 严重级别
     */
    CRITICAL("CRITICAL", "严重", 4);
    
    private String code;
    private String desc;
    private Integer priority;
    
    AlertLevel(String code, String desc, Integer priority) {
        this.code = code;
        this.desc = desc;
        this.priority = priority;
    }
}
```

#### NoticeWay - 通知方式

```java
public enum NoticeWay {
    /**
     * 邮件通知
     */
    EMAIL("EMAIL", "邮件"),
    
    /**
     * 钉钉通知
     */
    DINGDING("DINGDING", "钉钉"),
    
    /**
     * 企业微信通知
     */
    WECHAT("WECHAT", "企业微信"),
    
    /**
     * 短信通知
     */
    SMS("SMS", "短信"),
    
    /**
     * 飞书通知
     */
    FEISHU("FEISHU", "飞书"),
    
    /**
     * 自定义Webhook
     */
    WEBHOOK("WEBHOOK", "Webhook");
    
    private String code;
    private String desc;
    
    NoticeWay(String code, String desc) {
        this.code = code;
        this.desc = desc;
    }
}
```

### 2.5 数据库表结构

```sql
CREATE TABLE `t_ddh_alert_group` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `alert_group_name` varchar(255) NOT NULL COMMENT '告警组名称',
  `alert_group_category` varchar(50) DEFAULT NULL COMMENT '告警组类别',
  `cluster_id` int(11) NOT NULL COMMENT '集群ID',
  `alert_level` varchar(50) DEFAULT 'WARNING' COMMENT '告警级别',
  `notice_user_ids` varchar(500) DEFAULT NULL COMMENT '通知用户ID列表',
  `notice_group_user_ids` varchar(500) DEFAULT NULL COMMENT '通知用户组ID列表',
  `notice_way` varchar(200) NOT NULL COMMENT '通知方式',
  `email_config` text COMMENT '邮件配置',
  `dingding_config` text COMMENT '钉钉配置',
  `wechat_config` text COMMENT '企业微信配置',
  `sms_config` text COMMENT '短信配置',
  `webhook_config` text COMMENT 'Webhook配置',
  `feishu_config` text COMMENT '飞书配置',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_cluster_name` (`cluster_id`, `alert_group_name`),
  KEY `idx_cluster_id` (`cluster_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='告警组表';
```

## 三、ClusterAlertQuota - 告警指标实体

### 3.1 类定义

**文件位置**: `datasophon-domain/src/main/java/com/datasophon/domain/entity/ClusterAlertQuota.java`

```java
@Data
@TableName("t_ddh_cluster_alert_quota")
@ApiModel(value = "ClusterAlertQuota", description = "告警指标实体")
public class ClusterAlertQuota implements Serializable {
    
    private static final long serialVersionUID = 1L;
    
    /**
     * 主键ID
     */
    @TableId(value = "id", type = IdType.AUTO)
    @ApiModelProperty(value = "主键ID")
    private Integer id;
    
    /**
     * 集群ID
     */
    @ApiModelProperty(value = "集群ID", required = true)
    private Integer clusterId;
    
    /**
     * 指标名称
     */
    @ApiModelProperty(value = "指标名称", required = true)
    private String quotaName;
    
    /**
     * 服务名称（如 HDFS、YARN、Kafka）
     */
    @ApiModelProperty(value = "服务名称")
    private String serviceName;
    
    /**
     * 服务角色名称（如 NameNode、DataNode）
     */
    @ApiModelProperty(value = "服务角色名称")
    private String serviceRoleName;
    
    /**
     * 告警组ID
     */
    @ApiModelProperty(value = "告警组ID", required = true)
    private Integer alertGroupId;
    
    /**
     * 告警级别
     */
    @ApiModelProperty(value = "告警级别")
    private String alertLevel;
    
    /**
     * 告警表达式（Prometheus QL）
     */
    @ApiModelProperty(value = "告警表达式", required = true)
    private String alertExpr;
    
    /**
     * 告警持续时间（秒）
     */
    @ApiModelProperty(value = "告警持续时间")
    private Integer alertDuration;
    
    /**
     * 告警建议
     */
    @ApiModelProperty(value = "告警建议")
    private String alertAdvice;
    
    /**
     * 触发阈值
     */
    @ApiModelProperty(value = "触发阈值")
    private Double triggerThreshold;
    
    /**
     * 比较方法（>、<、==、!=、>=、<=）
     */
    @ApiModelProperty(value = "比较方法")
    private String compareMethod;
    
    /**
     * 是否启用（0-禁用，1-启用）
     */
    @ApiModelProperty(value = "是否启用")
    private Integer enabled;
    
    /**
     * 创建时间
     */
    @TableField(fill = FieldFill.INSERT)
    @ApiModelProperty(value = "创建时间")
    private Date createTime;
    
    /**
     * 更新时间
     */
    @TableField(fill = FieldFill.INSERT_UPDATE)
    @ApiModelProperty(value = "更新时间")
    private Date updateTime;
    
    /**
     * 告警组名称（非数据库字段）
     */
    @TableField(exist = false)
    @ApiModelProperty(value = "告警组名称")
    private String alertGroupName;
}
```

### 3.2 Prometheus 告警表达式示例

```promql
# CPU使用率告警
node_cpu_usage_percent > 80

# 内存使用率告警
node_memory_usage_percent > 85

# 磁盘使用率告警
node_disk_usage_percent{mountpoint="/"} > 90

# HDFS NameNode堆内存使用率
hdfs_namenode_heap_memory_usage_percent > 80

# YARN ResourceManager可用内存
yarn_resourcemanager_available_memory_mb < 10240

# Kafka消费者延迟
kafka_consumer_lag_seconds > 300

# 服务进程不可用
up{job="hdfs_namenode"} == 0

# 磁盘IO等待时间
node_disk_io_wait_percent > 50

# 网络丢包率
node_network_packet_loss_percent > 1
```

### 3.3 数据库表结构

```sql
CREATE TABLE `t_ddh_cluster_alert_quota` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `cluster_id` int(11) NOT NULL COMMENT '集群ID',
  `quota_name` varchar(255) NOT NULL COMMENT '指标名称',
  `service_name` varchar(100) DEFAULT NULL COMMENT '服务名称',
  `service_role_name` varchar(100) DEFAULT NULL COMMENT '服务角色名称',
  `alert_group_id` int(11) NOT NULL COMMENT '告警组ID',
  `alert_level` varchar(50) DEFAULT 'WARNING' COMMENT '告警级别',
  `alert_expr` text NOT NULL COMMENT '告警表达式',
  `alert_duration` int(11) DEFAULT 60 COMMENT '告警持续时间（秒）',
  `alert_advice` text COMMENT '告警建议',
  `trigger_threshold` decimal(10,2) DEFAULT NULL COMMENT '触发阈值',
  `compare_method` varchar(10) DEFAULT '>' COMMENT '比较方法',
  `enabled` tinyint(1) DEFAULT 1 COMMENT '是否启用',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_cluster_id` (`cluster_id`),
  KEY `idx_alert_group_id` (`alert_group_id`),
  KEY `idx_service_name` (`service_name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='告警指标表';
```

## 四、ClusterAlertRule - 告警规则实体

### 4.1 类定义

**文件位置**: `datasophon-domain/src/main/java/com/datasophon/domain/entity/ClusterAlertRule.java`

```java
@Data
@TableName("t_ddh_cluster_alert_rule")
@ApiModel(value = "ClusterAlertRule", description = "告警规则实体")
public class ClusterAlertRule implements Serializable {
    
    private static final long serialVersionUID = 1L;
    
    /**
     * 主键ID
     */
    @TableId(value = "id", type = IdType.AUTO)
    @ApiModelProperty(value = "主键ID")
    private Integer id;
    
    /**
     * 集群ID
     */
    @ApiModelProperty(value = "集群ID", required = true)
    private Integer clusterId;
    
    /**
     * 规则名称
     */
    @ApiModelProperty(value = "规则名称", required = true)
    private String ruleName;
    
    /**
     * 规则类型
     * THRESHOLD: 阈值告警
     * TREND: 趋势告警
     * ANOMALY: 异常检测
     * COMPOSITE: 复合告警
     */
    @ApiModelProperty(value = "规则类型")
    private String ruleType;
    
    /**
     * 告警组ID
     */
    @ApiModelProperty(value = "告警组ID", required = true)
    private Integer alertGroupId;
    
    /**
     * 触发条件（JSON格式）
     */
    @ApiModelProperty(value = "触发条件")
    private String triggerCondition;
    
    /**
     * 静默期（秒）
     */
    @ApiModelProperty(value = "静默期")
    private Integer silencePeriod;
    
    /**
     * 最大告警次数（防止告警风暴）
     */
    @ApiModelProperty(value = "最大告警次数")
    private Integer maxAlertCount;
    
    /**
     * 时间窗口（秒）
     */
    @ApiModelProperty(value = "时间窗口")
    private Integer timeWindow;
    
    /**
     * 是否启用（0-禁用，1-启用）
     */
    @ApiModelProperty(value = "是否启用")
    private Integer enabled;
    
    /**
     * 创建时间
     */
    @TableField(fill = FieldFill.INSERT)
    @ApiModelProperty(value = "创建时间")
    private Date createTime;
    
    /**
     * 更新时间
     */
    @TableField(fill = FieldFill.INSERT_UPDATE)
    @ApiModelProperty(value = "更新时间")
    private Date updateTime;
}
```

### 4.2 数据库表结构

```sql
CREATE TABLE `t_ddh_cluster_alert_rule` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `cluster_id` int(11) NOT NULL COMMENT '集群ID',
  `rule_name` varchar(255) NOT NULL COMMENT '规则名称',
  `rule_type` varchar(50) DEFAULT 'THRESHOLD' COMMENT '规则类型',
  `alert_group_id` int(11) NOT NULL COMMENT '告警组ID',
  `trigger_condition` text COMMENT '触发条件',
  `silence_period` int(11) DEFAULT 300 COMMENT '静默期（秒）',
  `max_alert_count` int(11) DEFAULT 10 COMMENT '最大告警次数',
  `time_window` int(11) DEFAULT 3600 COMMENT '时间窗口（秒）',
  `enabled` tinyint(1) DEFAULT 1 COMMENT '是否启用',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_cluster_id` (`cluster_id`),
  KEY `idx_alert_group_id` (`alert_group_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='告警规则表';
```

## 五、ClusterAlertHistory - 告警历史实体

### 5.1 类定义

**文件位置**: `datasophon-domain/src/main/java/com/datasophon/domain/entity/ClusterAlertHistory.java`

```java
@Data
@TableName("t_ddh_cluster_alert_history")
@ApiModel(value = "ClusterAlertHistory", description = "告警历史实体")
public class ClusterAlertHistory implements Serializable {
    
    private static final long serialVersionUID = 1L;
    
    /**
     * 主键ID（使用Long支持海量数据）
     */
    @TableId(value = "id", type = IdType.AUTO)
    @ApiModelProperty(value = "主键ID")
    private Long id;
    
    /**
     * 集群ID
     */
    @ApiModelProperty(value = "集群ID", required = true)
    private Integer clusterId;
    
    /**
     * 告警组ID
     */
    @ApiModelProperty(value = "告警组ID")
    private Integer alertGroupId;
    
    /**
     * 告警指标ID
     */
    @ApiModelProperty(value = "告警指标ID")
    private Integer alertQuotaId;
    
    /**
     * 告警级别
     */
    @ApiModelProperty(value = "告警级别")
    private String alertLevel;
    
    /**
     * 告警信息
     */
    @ApiModelProperty(value = "告警信息", required = true)
    private String alertInfo;
    
    /**
     * 告警建议
     */
    @ApiModelProperty(value = "告警建议")
    private String alertAdvice;
    
    /**
     * 主机名
     */
    @ApiModelProperty(value = "主机名")
    private String hostname;
    
    /**
     * 服务名称
     */
    @ApiModelProperty(value = "服务名称")
    private String serviceName;
    
    /**
     * 服务角色名称
     */
    @ApiModelProperty(value = "服务角色名称")
    private String serviceRoleName;
    
    /**
     * 告警状态（0-触发，1-恢复）
     */
    @ApiModelProperty(value = "告警状态")
    private Integer alertStatus;
    
    /**
     * 告警时间
     */
    @ApiModelProperty(value = "告警时间")
    private Date alertTime;
    
    /**
     * 恢复时间
     */
    @ApiModelProperty(value = "恢复时间")
    private Date resolveTime;
    
    /**
     * 通知状态（SUCCESS、FAILED、PENDING）
     */
    @ApiModelProperty(value = "通知状态")
    private String noticeStatus;
    
    /**
     * 通知重试次数
     */
    @ApiModelProperty(value = "通知重试次数")
    private Integer noticeRetryCount;
    
    /**
     * 创建时间
     */
    @TableField(fill = FieldFill.INSERT)
    @ApiModelProperty(value = "创建时间")
    private Date createTime;
    
    /**
     * 更新时间
     */
    @TableField(fill = FieldFill.INSERT_UPDATE)
    @ApiModelProperty(value = "更新时间")
    private Date updateTime;
}
```

### 5.2 数据库表结构

```sql
CREATE TABLE `t_ddh_cluster_alert_history` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `cluster_id` int(11) NOT NULL COMMENT '集群ID',
  `alert_group_id` int(11) DEFAULT NULL COMMENT '告警组ID',
  `alert_quota_id` int(11) DEFAULT NULL COMMENT '告警指标ID',
  `alert_level` varchar(50) DEFAULT NULL COMMENT '告警级别',
  `alert_info` text NOT NULL COMMENT '告警信息',
  `alert_advice` text COMMENT '告警建议',
  `hostname` varchar(255) DEFAULT NULL COMMENT '主机名',
  `service_name` varchar(100) DEFAULT NULL COMMENT '服务名称',
  `service_role_name` varchar(100) DEFAULT NULL COMMENT '服务角色名称',
  `alert_status` tinyint(1) DEFAULT 0 COMMENT '告警状态',
  `alert_time` datetime NOT NULL COMMENT '告警时间',
  `resolve_time` datetime DEFAULT NULL COMMENT '恢复时间',
  `notice_status` varchar(20) DEFAULT 'PENDING' COMMENT '通知状态',
  `notice_retry_count` int(11) DEFAULT 0 COMMENT '通知重试次数',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_cluster_id` (`cluster_id`),
  KEY `idx_alert_time` (`alert_time`),
  KEY `idx_alert_status` (`alert_status`),
  KEY `idx_service_name` (`service_name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='告警历史表';
```

## 六、ClusterAlertGroupMap - 集群告警组映射实体

### 6.1 类定义

**文件位置**: `datasophon-domain/src/main/java/com/datasophon/domain/entity/ClusterAlertGroupMap.java`

```java
@Data
@TableName("t_ddh_cluster_alert_group_map")
@ApiModel(value = "ClusterAlertGroupMap", description = "集群告警组映射实体")
public class ClusterAlertGroupMap implements Serializable {
    
    private static final long serialVersionUID = 1L;
    
    /**
     * 主键ID
     */
    @TableId(value = "id", type = IdType.AUTO)
    @ApiModelProperty(value = "主键ID")
    private Integer id;
    
    /**
     * 集群ID
     */
    @ApiModelProperty(value = "集群ID", required = true)
    private Integer clusterId;
    
    /**
     * 告警组ID
     */
    @ApiModelProperty(value = "告警组ID", required = true)
    private Integer alertGroupId;
    
    /**
     * 创建时间
     */
    @TableField(fill = FieldFill.INSERT)
    @ApiModelProperty(value = "创建时间")
    private Date createTime;
}
```

### 6.2 数据库表结构

```sql
CREATE TABLE `t_ddh_cluster_alert_group_map` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `cluster_id` int(11) NOT NULL COMMENT '集群ID',
  `alert_group_id` int(11) NOT NULL COMMENT '告警组ID',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_cluster_alert_group` (`cluster_id`, `alert_group_id`),
  KEY `idx_cluster_id` (`cluster_id`),
  KEY `idx_alert_group_id` (`alert_group_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='集群告警组映射表';
```

## 七、总结

### 7.1 实体设计特点

1. **清晰的职责划分**: 每个实体类负责特定的业务领域
2. **完善的注解支持**: 使用 MyBatis-Plus、Swagger 等注解
3. **灵活的配置存储**: 使用 JSON 格式存储复杂配置
4. **完整的审计字段**: 创建时间、更新时间自动维护
5. **合理的索引设计**: 优化查询性能
6. **支持海量数据**: 告警历史表使用 Long 类型主键

### 7.2 实体关系总结

| 实体类 | 主要用途 | 关联实体 |
|--------|----------|----------|
| AlertGroupEntity | 告警组管理 | ClusterInfoEntity、ClusterAlertQuota |
| ClusterAlertQuota | 告警指标配置 | AlertGroupEntity、ClusterAlertHistory |
| ClusterAlertRule | 告警规则定义 | AlertGroupEntity |
| ClusterAlertHistory | 告警历史记录 | AlertGroupEntity、ClusterAlertQuota |
| ClusterAlertGroupMap | 集群告警组映射 | ClusterInfoEntity、AlertGroupEntity |

### 7.3 最佳实践

1. **使用枚举类型**: 统一管理状态和类型常量
2. **JSON配置存储**: 灵活存储复杂配置，便于扩展
3. **合理的字段类型**: 根据数据规模选择合适的类型
4. **完善的索引**: 为常用查询字段创建索引
5. **非数据库字段**: 使用 @TableField(exist = false) 标识
6. **自动填充**: 利用 MyBatis-Plus 自动填充创建、更新时间

---

**文档版本**: v1.0  
**最后更新**: 2025-11-16  
**维护者**: DataSophon 源码分析团队  
**关联文档**: 
- [Service 层 - 03-告警组服务详解.md](../service/03-告警组服务详解.md)
- [API 层 - 06-告警管理Controller.md](../api/06-告警管理Controller.md)
- [Domain 层 - 00-Domain与Infrastructure模块总览.md](./00-Domain与Infrastructure模块总览.md)
