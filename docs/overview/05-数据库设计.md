# DataSophon 数据库设计分析

## 一、数据库概述

### 1.1 数据库类型
- **RDBMS**: MySQL 5.7+
- **字符集**: UTF-8
- **存储引擎**: InnoDB
- **事务支持**: 是

### 1.2 数据库命名
- **数据库名**: `datasophon`
- **表前缀**: `t_ddh_`
- **命名规范**: 下划线分隔，全小写

## 二、核心表结构

### 2.1 集群相关表

#### t_ddh_cluster_info (集群信息表)

**功能**: 存储集群的基本信息

**字段说明**:
```sql
CREATE TABLE `t_ddh_cluster_info` (
  `id` INT(11) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `cluster_name` VARCHAR(128) NOT NULL COMMENT '集群名称',
  `cluster_code` VARCHAR(64) NOT NULL COMMENT '集群编码',
  `cluster_frame` VARCHAR(32) COMMENT '集群框架(DDP-1.2.0)',
  `frame_version` VARCHAR(32) COMMENT '框架版本',
  `cluster_state` INT(11) DEFAULT 1 COMMENT '集群状态(1:待配置,2:正在运行,3:已停止)',
  `create_by` VARCHAR(64) COMMENT '创建人',
  `create_time` DATETIME COMMENT '创建时间',
  `update_time` DATETIME COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_cluster_name` (`cluster_name`),
  UNIQUE KEY `uk_cluster_code` (`cluster_code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='集群信息表';
```

**关键索引**:
- `PRIMARY KEY (id)`: 主键索引
- `uk_cluster_name`: 集群名称唯一索引
- `uk_cluster_code`: 集群编码唯一索引

**关联关系**:
- 一对多: cluster_host (一个集群包含多个主机)
- 一对多: cluster_service_instance (一个集群包含多个服务实例)
- 一对多: cluster_alert_group_map (一个集群可配置多个告警组)

#### t_ddh_cluster_host (集群主机表)

**功能**: 存储集群中的主机节点信息

**字段说明**:
```sql
CREATE TABLE `t_ddh_cluster_host` (
  `id` INT(11) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `cluster_id` INT(11) NOT NULL COMMENT '集群ID',
  `hostname` VARCHAR(255) NOT NULL COMMENT '主机名',
  `ip` VARCHAR(64) NOT NULL COMMENT 'IP地址',
  `rack` VARCHAR(64) COMMENT '机架',
  `core_num` INT(11) COMMENT 'CPU核心数',
  `total_mem` BIGINT COMMENT '总内存(MB)',
  `total_disk` BIGINT COMMENT '总磁盘(GB)',
  `used_mem` BIGINT COMMENT '已用内存(MB)',
  `used_disk` BIGINT COMMENT '已用磁盘(GB)',
  `cpu_architecture` VARCHAR(32) COMMENT 'CPU架构(x86_64/aarch64)',
  `host_state` INT(11) DEFAULT 1 COMMENT '主机状态(1:在线,2:离线)',
  `managed` INT(11) DEFAULT 0 COMMENT '是否被管理(0:否,1:是)',
  `create_time` DATETIME COMMENT '创建时间',
  `update_time` DATETIME COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_cluster_id` (`cluster_id`),
  KEY `idx_hostname` (`hostname`),
  KEY `idx_ip` (`ip`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='集群主机表';
```

**关键索引**:
- `idx_cluster_id`: 集群ID索引，用于查询某个集群的所有主机
- `idx_hostname`: 主机名索引，用于根据主机名查询
- `idx_ip`: IP地址索引，用于根据IP查询

### 2.2 服务相关表

#### t_ddh_cluster_service_instance (服务实例表)

**功能**: 存储集群中安装的服务实例

**字段说明**:
```sql
CREATE TABLE `t_ddh_cluster_service_instance` (
  `id` INT(11) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `cluster_id` INT(11) NOT NULL COMMENT '集群ID',
  `service_name` VARCHAR(64) NOT NULL COMMENT '服务名称(HDFS,YARN等)',
  `label` VARCHAR(128) COMMENT '服务标签',
  `service_version` VARCHAR(32) COMMENT '服务版本',
  `service_state` INT(11) DEFAULT 1 COMMENT '服务状态(1:待安装,2:安装中,3:运行中,4:已停止)',
  `update_time` DATETIME COMMENT '更新时间',
  `create_time` DATETIME COMMENT '创建时间',
  `need_restart` INT(11) DEFAULT 0 COMMENT '是否需要重启(0:否,1:是)',
  `frame_service_id` INT(11) COMMENT '框架服务ID',
  PRIMARY KEY (`id`),
  KEY `idx_cluster_id` (`cluster_id`),
  KEY `idx_service_name` (`service_name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='服务实例表';
```

**服务状态枚举**:
- 1: 待安装 (WAIT_INSTALL)
- 2: 安装中 (INSTALLING)
- 3: 运行中 (RUNNING)
- 4: 已停止 (STOP)
- 5: 存在告警 (EXISTS_ALARM)
- 6: 需要重启 (NEED_RESTART)

#### t_ddh_cluster_service_role_instance (服务角色实例表)

**功能**: 存储服务角色的实例信息

**字段说明**:
```sql
CREATE TABLE `t_ddh_cluster_service_role_instance` (
  `id` INT(11) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `service_id` INT(11) NOT NULL COMMENT '服务实例ID',
  `service_role_name` VARCHAR(64) NOT NULL COMMENT '服务角色名称(NameNode,DataNode等)',
  `hostname` VARCHAR(255) NOT NULL COMMENT '主机名',
  `service_role_state` INT(11) DEFAULT 1 COMMENT '角色状态',
  `update_time` DATETIME COMMENT '更新时间',
  `create_time` DATETIME COMMENT '创建时间',
  `role_type` INT(11) COMMENT '角色类型(1:master,2:slave,3:client)',
  `frame_service_role_id` INT(11) COMMENT '框架服务角色ID',
  PRIMARY KEY (`id`),
  KEY `idx_service_id` (`service_id`),
  KEY `idx_hostname` (`hostname`),
  KEY `idx_role_name` (`service_role_name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='服务角色实例表';
```

**示例数据**:
```
HDFS 服务的角色实例:
- NameNode (master) - host1
- SecondaryNameNode (master) - host2
- DataNode (slave) - host3, host4, host5
```

#### t_ddh_cluster_service_instance_config (服务配置表)

**功能**: 存储服务实例的配置信息

**字段说明**:
```sql
CREATE TABLE `t_ddh_cluster_service_instance_config` (
  `id` INT(11) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `service_id` INT(11) NOT NULL COMMENT '服务实例ID',
  `config_file_name` VARCHAR(128) COMMENT '配置文件名',
  `config_version` INT(11) DEFAULT 1 COMMENT '配置版本',
  `config_data` TEXT COMMENT '配置内容(JSON格式)',
  `config_data_md5` VARCHAR(64) COMMENT '配置MD5',
  `create_time` DATETIME COMMENT '创建时间',
  `update_time` DATETIME COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_service_id` (`service_id`),
  KEY `idx_config_file` (`config_file_name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='服务配置表';
```

**配置存储格式**:
```json
{
  "dfs.replication": "3",
  "dfs.namenode.name.dir": "/data/hadoop/namenode",
  "dfs.datanode.data.dir": "/data/hadoop/datanode",
  "dfs.blocksize": "134217728"
}
```

### 2.3 命令执行相关表

#### t_ddh_cluster_service_command (服务命令表)

**功能**: 记录服务操作命令的执行情况

**字段说明**:
```sql
CREATE TABLE `t_ddh_cluster_service_command` (
  `id` INT(11) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `command_name` VARCHAR(128) NOT NULL COMMENT '命令名称',
  `command_type` INT(11) NOT NULL COMMENT '命令类型(1:安装,2:启动,3:停止,4:重启)',
  `cluster_id` INT(11) NOT NULL COMMENT '集群ID',
  `service_name` VARCHAR(64) COMMENT '服务名称',
  `command_state` INT(11) DEFAULT 1 COMMENT '命令状态(1:等待,2:运行中,3:成功,4:失败)',
  `command_progress` INT(11) DEFAULT 0 COMMENT '命令进度(0-100)',
  `submit_time` DATETIME COMMENT '提交时间',
  `start_time` DATETIME COMMENT '开始时间',
  `end_time` DATETIME COMMENT '结束时间',
  `create_by` VARCHAR(64) COMMENT '创建人',
  PRIMARY KEY (`id`),
  KEY `idx_cluster_id` (`cluster_id`),
  KEY `idx_command_state` (`command_state`),
  KEY `idx_submit_time` (`submit_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='服务命令表';
```

**命令类型枚举**:
- 1: 安装服务 (INSTALL_SERVICE)
- 2: 启动服务 (START_SERVICE)
- 3: 停止服务 (STOP_SERVICE)
- 4: 重启服务 (RESTART_SERVICE)
- 5: 配置服务 (CONFIGURE_SERVICE)

#### t_ddh_cluster_service_command_host (命令主机关联表)

**功能**: 记录命令在各个主机上的执行情况

**字段说明**:
```sql
CREATE TABLE `t_ddh_cluster_service_command_host` (
  `id` INT(11) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `command_id` INT(11) NOT NULL COMMENT '命令ID',
  `hostname` VARCHAR(255) NOT NULL COMMENT '主机名',
  `command_state` INT(11) DEFAULT 1 COMMENT '命令状态',
  `command_progress` INT(11) DEFAULT 0 COMMENT '命令进度',
  `result_msg` TEXT COMMENT '执行结果信息',
  `start_time` DATETIME COMMENT '开始时间',
  `end_time` DATETIME COMMENT '结束时间',
  PRIMARY KEY (`id`),
  KEY `idx_command_id` (`command_id`),
  KEY `idx_hostname` (`hostname`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='命令主机关联表';
```

### 2.4 告警相关表

#### t_ddh_cluster_alert_group (告警组表)

**功能**: 定义告警组及其成员

**字段说明**:
```sql
CREATE TABLE `t_ddh_cluster_alert_group` (
  `id` INT(11) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `alert_group_name` VARCHAR(128) NOT NULL COMMENT '告警组名称',
  `alert_group_category` VARCHAR(64) COMMENT '告警组类别',
  `create_time` DATETIME COMMENT '创建时间',
  `update_time` DATETIME COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_alert_group_name` (`alert_group_name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='告警组表';
```

#### t_ddh_cluster_alert_history (告警历史表)

**功能**: 记录所有告警历史

**字段说明**:
```sql
CREATE TABLE `t_ddh_cluster_alert_history` (
  `id` INT(11) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `alert_group_id` INT(11) NOT NULL COMMENT '告警组ID',
  `cluster_id` INT(11) NOT NULL COMMENT '集群ID',
  `alert_target_name` VARCHAR(128) COMMENT '告警目标名称',
  `alert_level` VARCHAR(32) COMMENT '告警级别(info,warning,error,critical)',
  `alert_info` TEXT COMMENT '告警信息',
  `alert_advice` TEXT COMMENT '告警建议',
  `is_enabled` INT(11) DEFAULT 1 COMMENT '是否启用(0:否,1:是)',
  `create_time` DATETIME COMMENT '创建时间',
  `update_time` DATETIME COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_cluster_id` (`cluster_id`),
  KEY `idx_alert_group_id` (`alert_group_id`),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='告警历史表';
```

**告警级别**:
- info: 信息级别
- warning: 警告级别
- error: 错误级别
- critical: 严重级别

#### t_ddh_cluster_alert_quota (告警指标表)

**功能**: 定义告警指标和规则

**字段说明**:
```sql
CREATE TABLE `t_ddh_cluster_alert_quota` (
  `id` INT(11) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `alert_quota_name` VARCHAR(128) NOT NULL COMMENT '指标名称',
  `service_name` VARCHAR(64) COMMENT '服务名称',
  `service_role_name` VARCHAR(64) COMMENT '服务角色名称',
  `alert_expr` TEXT COMMENT '告警表达式(PromQL)',
  `alert_level` VARCHAR(32) COMMENT '告警级别',
  `compare_method` VARCHAR(32) COMMENT '比较方法(>,<,==,>=,<=)',
  `alert_threshold` VARCHAR(64) COMMENT '告警阈值',
  `trigger_duration` INT(11) COMMENT '触发时长(秒)',
  `alert_advice` TEXT COMMENT '告警建议',
  PRIMARY KEY (`id`),
  KEY `idx_service_name` (`service_name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='告警指标表';
```

**示例告警规则**:
```
指标名称: DataNode磁盘使用率
告警表达式: (node_filesystem_size_bytes - node_filesystem_free_bytes) / node_filesystem_size_bytes * 100
比较方法: >
告警阈值: 90
触发时长: 300 (5分钟)
告警级别: warning
```

### 2.5 用户权限相关表

#### t_ddh_user_info (用户信息表)

**字段说明**:
```sql
CREATE TABLE `t_ddh_user_info` (
  `id` INT(11) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `username` VARCHAR(64) NOT NULL COMMENT '用户名',
  `password` VARCHAR(128) NOT NULL COMMENT '密码(加密)',
  `email` VARCHAR(128) COMMENT '邮箱',
  `phone` VARCHAR(32) COMMENT '手机号',
  `create_time` DATETIME COMMENT '创建时间',
  `update_time` DATETIME COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='用户信息表';
```

#### t_ddh_role_info (角色信息表)

**字段说明**:
```sql
CREATE TABLE `t_ddh_role_info` (
  `id` INT(11) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `role_code` VARCHAR(64) NOT NULL COMMENT '角色编码',
  `role_name` VARCHAR(128) NOT NULL COMMENT '角色名称',
  `create_time` DATETIME COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_role_code` (`role_code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='角色信息表';
```

**默认角色**:
- admin: 管理员角色，拥有所有权限
- operator: 操作员角色，可以操作服务但不能删除
- viewer: 查看者角色，只能查看不能操作

#### t_ddh_user_role (用户角色关联表)

**字段说明**:
```sql
CREATE TABLE `t_ddh_user_role` (
  `id` INT(11) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `user_id` INT(11) NOT NULL COMMENT '用户ID',
  `role_id` INT(11) NOT NULL COMMENT '角色ID',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_role_id` (`role_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='用户角色关联表';
```

### 2.6 框架元数据表

#### t_ddh_frame_service (框架服务表)

**功能**: 定义框架支持的服务类型

**字段说明**:
```sql
CREATE TABLE `t_ddh_frame_service` (
  `id` INT(11) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `service_name` VARCHAR(64) NOT NULL COMMENT '服务名称',
  `label` VARCHAR(128) COMMENT '服务标签',
  `service_version` VARCHAR(32) COMMENT '服务版本',
  `service_desc` TEXT COMMENT '服务描述',
  `frame_code` VARCHAR(32) COMMENT '框架编码',
  `package_name` VARCHAR(255) COMMENT '安装包名称',
  `service_json` TEXT COMMENT '服务JSON配置',
  `sort_num` INT(11) COMMENT '排序号',
  PRIMARY KEY (`id`),
  KEY `idx_frame_code` (`frame_code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='框架服务表';
```

#### t_ddh_frame_service_role (框架服务角色表)

**功能**: 定义服务包含的角色

**字段说明**:
```sql
CREATE TABLE `t_ddh_frame_service_role` (
  `id` INT(11) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `service_id` INT(11) NOT NULL COMMENT '框架服务ID',
  `service_role_name` VARCHAR(64) NOT NULL COMMENT '服务角色名称',
  `service_role_label` VARCHAR(128) COMMENT '服务角色标签',
  `service_role_type` INT(11) COMMENT '角色类型(1:master,2:slave,3:client)',
  `cardinality` VARCHAR(32) COMMENT '基数(1,1+,1-2)',
  `role_json` TEXT COMMENT '角色JSON配置',
  `sort_num` INT(11) COMMENT '排序号',
  PRIMARY KEY (`id`),
  KEY `idx_service_id` (`service_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='框架服务角色表';
```

**基数说明**:
- `1`: 必须有且只有1个实例
- `1+`: 至少有1个实例
- `0-1`: 可以有0个或1个实例
- `1-N`: 可以有1到N个实例

## 三、表关系图

```
t_ddh_cluster_info (集群)
    ├─── t_ddh_cluster_host (主机)
    ├─── t_ddh_cluster_service_instance (服务实例)
    │       ├─── t_ddh_cluster_service_role_instance (角色实例)
    │       └─── t_ddh_cluster_service_instance_config (服务配置)
    ├─── t_ddh_cluster_service_command (命令)
    │       └─── t_ddh_cluster_service_command_host (命令执行详情)
    ├─── t_ddh_cluster_alert_history (告警历史)
    └─── t_ddh_cluster_alert_group_map (告警组映射)

t_ddh_frame_service (框架服务定义)
    └─── t_ddh_frame_service_role (服务角色定义)

t_ddh_user_info (用户)
    └─── t_ddh_user_role (用户角色)
            └─── t_ddh_role_info (角色)
```

## 四、索引策略

### 4.1 主键索引
所有表都使用自增 INT 类型主键，提供高效的主键查询。

### 4.2 唯一索引
- 集群名称、集群编码
- 用户名
- 角色编码
- 告警组名称

### 4.3 普通索引
- cluster_id: 用于根据集群查询相关数据
- hostname: 用于根据主机查询
- service_name: 用于根据服务名查询
- create_time: 用于时间范围查询

### 4.4 组合索引建议
```sql
-- 查询某个集群某个服务的命令历史
ALTER TABLE t_ddh_cluster_service_command 
ADD INDEX idx_cluster_service (cluster_id, service_name, submit_time);

-- 查询某个主机上的所有角色实例
ALTER TABLE t_ddh_cluster_service_role_instance
ADD INDEX idx_hostname_state (hostname, service_role_state);
```

## 五、数据库迁移

### 5.1 版本管理
DataSophon 使用 Flyway 进行数据库版本管理：

```
db/migration/
├── 1.1.0/
│   ├── V1.1.0__DDL.sql      # DDL 变更
│   └── V1.1.0__DML.sql      # DML 变更
├── 1.1.1/
│   ├── V1.1.1__DDL.sql
│   └── V1.1.1__DML.sql
└── 1.2.0/
    ├── V1.2.0__DDL.sql
    └── V1.2.0__DML.sql
```

### 5.2 迁移脚本示例

**V1.1.0__DDL.sql** (表结构变更):
```sql
-- 添加新字段
ALTER TABLE t_ddh_cluster_host 
ADD COLUMN cpu_architecture VARCHAR(32) COMMENT 'CPU架构';

-- 创建新表
CREATE TABLE t_ddh_cluster_rack (
  `id` INT(11) NOT NULL AUTO_INCREMENT,
  `rack` VARCHAR(64) NOT NULL,
  `cluster_id` INT(11) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```

**V1.1.0__DML.sql** (数据变更):
```sql
-- 更新默认值
UPDATE t_ddh_cluster_host 
SET cpu_architecture = 'x86_64' 
WHERE cpu_architecture IS NULL;

-- 插入默认数据
INSERT INTO t_ddh_role_info (role_code, role_name) 
VALUES ('viewer', '查看者');
```

## 六、性能优化建议

### 6.1 分页查询优化
```sql
-- 避免使用 OFFSET
SELECT * FROM t_ddh_cluster_host 
WHERE id > last_id 
ORDER BY id LIMIT 20;
```

### 6.2 大表优化
对于告警历史表等可能快速增长的表：
- 定期归档历史数据
- 使用分区表
- 建立合适的索引

### 6.3 慢查询优化
- 启用慢查询日志
- 定期分析慢查询
- 优化查询语句
- 添加必要的索引

## 七、备份策略

### 7.1 全量备份
```bash
# 每天凌晨2点执行全量备份
mysqldump -h localhost -u root -p datasophon \
  --single-transaction \
  --quick \
  --lock-tables=false \
  > datasophon_$(date +%Y%m%d).sql
```

### 7.2 增量备份
启用 binlog 进行增量备份：
```ini
[mysqld]
log-bin=mysql-bin
binlog_format=ROW
expire_logs_days=7
```

### 7.3 备份保留策略
- 全量备份保留30天
- 增量备份(binlog)保留7天
- 月度备份永久保留

---

**文档版本**: v1.0  
**最后更新**: 2025-11-15
