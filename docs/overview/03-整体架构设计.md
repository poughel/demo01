# DataSophon 整体架构设计

## 一、系统架构概览

DataSophon 采用经典的分层架构和 Master-Worker 分布式架构相结合的设计，实现大数据集群的自动化管理和监控。

### 1.1 总体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                         用户层                               │
│                    Web Browser / API Client                 │
└──────────────────────┬──────────────────────────────────────┘
                       │ HTTP/HTTPS
┌──────────────────────┴──────────────────────────────────────┐
│                      前端展示层                               │
│                   datasophon-ui (Vue.js)                    │
│  ┌────────────┬───────────┬──────────┬──────────┬─────────┐ │
│  │ 集群管理   │ 服务管理  │ 主机管理 │ 监控大盘 │ 告警管理 │ │
│  └────────────┴───────────┴──────────┴──────────┴─────────┘ │
└──────────────────────┬──────────────────────────────────────┘
                       │ REST API
┌──────────────────────┴──────────────────────────────────────┐
│                       API 层                                 │
│                   datasophon-api (Spring Boot)              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  Controller 层 (HTTP 请求处理)                         │ │
│  │  ┌──────────┬──────────┬──────────┬──────────────────┐│ │
│  │  │ Cluster  │ Service  │  Host    │  Alert  │  User  ││ │
│  │  │Controller│Controller│Controller│Controller│Ctrl    ││ │
│  │  └──────────┴──────────┴──────────┴──────────┴────────┘│ │
│  └────────────────────────────────────────────────────────┘ │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  Security 层 (认证授权)                                │ │
│  │  - Authentication / Authorization / Permission         │ │
│  └────────────────────────────────────────────────────────┘ │
└──────────────────────┬──────────────────────────────────────┘
                       │
┌──────────────────────┴──────────────────────────────────────┐
│                     业务逻辑层                               │
│                   datasophon-service                        │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  Service 层 (业务逻辑处理)                             │ │
│  │  ┌──────────────┬─────────────┬──────────────────────┐│ │
│  │  │ClusterService│ServiceInstall│AlertService│Monitor ││ │
│  │  │              │Service       │            │Service  ││ │
│  │  └──────────────┴─────────────┴──────────────────────┘│ │
│  └────────────────────────────────────────────────────────┘ │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  Actor 系统 (分布式任务调度)                           │ │
│  │  ┌──────────┬──────────┬──────────┬─────────────────┐│ │
│  │  │Dispatcher│Cluster   │DAGBuild  │ServiceExecute   ││ │
│  │  │Actor     │Actor     │Actor     │ResultActor      ││ │
│  │  └──────────┴──────────┴──────────┴─────────────────┘│ │
│  └────────────────────────────────────────────────────────┘ │
└──────────────────────┬──────────────────────────────────────┘
                       │
┌──────────────────────┴──────────────────────────────────────┐
│                     领域模型层                               │
│                   datasophon-domain                         │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  Entity (实体类)                                        │ │
│  │  ClusterInfo / ServiceInstance / ClusterHost / ...     │ │
│  └────────────────────────────────────────────────────────┘ │
└──────────────────────┬──────────────────────────────────────┘
                       │
┌──────────────────────┴──────────────────────────────────────┐
│                   基础设施层                                 │
│                datasophon-infrastructure                    │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  Mapper 层 (MyBatis)                                    │ │
│  │  ┌──────────┬──────────┬──────────┬─────────────────┐│ │
│  │  │Cluster   │Service   │Host      │Alert            ││ │
│  │  │Mapper    │Mapper    │Mapper    │Mapper           ││ │
│  │  └──────────┴──────────┴──────────┴─────────────────┘│ │
│  └────────────────────────────────────────────────────────┘ │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  Repository (仓储实现)                                  │ │
│  └────────────────────────────────────────────────────────┘ │
└──────────────────────┬──────────────────────────────────────┘
                       │
                ┌──────┴──────┐
                │   MySQL     │
                │  Database   │
                └─────────────┘

         ┌──────── Actor 消息通信 ──────────┐
         │                                  │
         ▼                                  ▼
┌─────────────────┐              ┌─────────────────┐
│  Worker Node 1  │              │  Worker Node N  │
│datasophon-worker│  ◄─────────► │datasophon-worker│
│  ┌───────────┐  │              │  ┌───────────┐  │
│  │  Actor    │  │              │  │  Actor    │  │
│  │  System   │  │              │  │  System   │  │
│  └───────────┘  │              │  └───────────┘  │
│  ┌───────────┐  │              │  ┌───────────┐  │
│  │  Handler  │  │              │  │  Handler  │  │
│  │  (命令执行)│  │              │  │  (命令执行)│  │
│  └───────────┘  │              │  └───────────┘  │
│  ┌───────────┐  │              │  ┌───────────┐  │
│  │  Monitor  │  │              │  │  Monitor  │  │
│  │  (监控采集)│  │              │  │  (监控采集)│  │
│  └───────────┘  │              │  └───────────┘  │
└─────────────────┘              └─────────────────┘
         │                                  │
         └────── 管理的服务进程 ──────────────┘
              HDFS / YARN / Spark / ...
```

## 二、分层架构详解

### 2.1 前端展示层 (Presentation Layer)

**技术栈**: Vue.js 2.x + Element UI + Vuex + Vue Router

**职责**:
- 用户交互界面
- 数据可视化展示
- 前后端交互

**核心组件**:
- 集群管理界面
- 服务部署向导
- 监控大盘
- 告警中心
- 用户管理

### 2.2 API 层 (API Layer)

**技术栈**: Spring Boot + Spring MVC + Spring Security

**职责**:
- RESTful API 接口提供
- 请求参数验证
- 用户认证授权
- 统一异常处理

**设计模式**:
- **Controller 模式**: 处理 HTTP 请求
- **拦截器模式**: 权限验证、日志记录
- **统一响应格式**: Result 封装

### 2.3 业务逻辑层 (Business Logic Layer)

**技术栈**: Spring + Actor 模型 (Akka)

**职责**:
- 核心业务逻辑实现
- 分布式任务调度
- 命令分发与执行
- 服务编排

**核心组件**:
- **Service 层**: 业务逻辑实现
- **Actor 系统**: 分布式任务处理
- **Strategy 策略**: 不同服务的操作策略
- **DAG 引擎**: 任务依赖关系处理

### 2.4 领域模型层 (Domain Layer)

**技术栈**: Plain Java Objects (POJOs)

**职责**:
- 领域实体定义
- 业务对象封装
- 值对象定义

**核心实体**:
- ClusterInfoEntity: 集群信息
- ServiceInstanceEntity: 服务实例
- ClusterHostEntity: 主机节点
- AlertGroupEntity: 告警组

### 2.5 基础设施层 (Infrastructure Layer)

**技术栈**: MyBatis + MySQL + Redis

**职责**:
- 数据持久化
- 缓存管理
- 消息队列
- 外部系统集成

**核心组件**:
- **Mapper 接口**: 数据库访问
- **Repository**: 仓储实现
- **CacheUtils**: 缓存工具
- **HttpUtils**: HTTP 客户端

## 三、Master-Worker 架构

### 3.1 Master 节点 (datasophon-api)

**角色**: 控制中心，负责整体调度和管理

**职责**:
1. **集群管理**: 集群创建、配置、删除
2. **服务调度**: 服务安装、启动、停止、配置
3. **主机管理**: 主机添加、删除、监控
4. **任务分发**: 将任务分发到 Worker 节点
5. **状态管理**: 维护集群、服务、主机状态
6. **监控告警**: 监控数据聚合、告警规则管理

**通信方式**:
- 与前端: HTTP/HTTPS
- 与 Worker: Actor 消息通信 (Akka)
- 与数据库: JDBC

### 3.2 Worker 节点 (datasophon-worker)

**角色**: 执行者，在各个节点上执行具体任务

**职责**:
1. **命令执行**: 执行 Master 下发的命令
2. **服务管理**: 启动、停止、重启服务进程
3. **配置管理**: 生成和更新配置文件
4. **进程监控**: 监控本地服务进程状态
5. **指标采集**: 采集监控指标数据
6. **日志收集**: 收集服务日志

**通信方式**:
- 与 Master: Actor 消息通信
- 与本地服务: Shell 命令、API 调用

### 3.3 Master-Worker 通信机制

**Actor 模型**:
```
Master (datasophon-api)
   ├── DispatcherWorkerActor (命令分发)
   │   └── 发送命令消息
   ├── ServiceExecuteResultActor (结果接收)
   │   └── 接收执行结果
   └── SubmitTaskNodeActor (任务提交)
       └── 管理任务队列

Worker (datasophon-worker)
   ├── WorkerActor (命令接收)
   │   └── 接收并处理命令
   ├── Handler (命令处理器)
   │   ├── InstallCommandHandler
   │   ├── StartCommandHandler
   │   └── StopCommandHandler
   └── Reporter (结果上报)
       └── 上报执行结果
```

**消息类型**:
- InstallCommand: 安装服务
- StartCommand: 启动服务
- StopCommand: 停止服务
- RestartCommand: 重启服务
- ConfigCommand: 更新配置
- MonitorCommand: 采集监控数据

## 四、核心技术架构

### 4.1 Actor 模型架构

DataSophon 使用 Akka Actor 模型实现分布式任务调度：

**优势**:
- 异步消息传递，提高并发性能
- 容错机制，自动重试失败任务
- 位置透明，支持分布式部署
- 负载均衡，任务均匀分配

**核心 Actor**:
- **ClusterActor**: 集群级别任务处理
- **DAGBuildActor**: 构建任务依赖图
- **DispatcherWorkerActor**: 分发任务到 Worker
- **ServiceExecuteResultActor**: 收集执行结果
- **PrometheusActor**: Prometheus 监控集成

### 4.2 DAG 任务编排

服务之间存在依赖关系，使用 DAG (有向无环图) 管理任务执行顺序：

```
启动 Hadoop 集群示例:
    HDFS NameNode (启动)
         ↓
    HDFS DataNode (启动)
         ↓
    YARN ResourceManager (启动)
         ↓
    YARN NodeManager (启动)
```

**实现原理**:
1. 解析服务依赖关系
2. 构建 DAG 图
3. 拓扑排序确定执行顺序
4. 并行执行无依赖的任务
5. 失败重试和回滚

### 4.3 服务策略模式

不同的服务有不同的操作策略，使用策略模式实现：

```java
interface ServiceRoleStrategy {
    void start();
    void stop();
    void restart();
    void configure();
}

class HdfsNameNodeStrategy implements ServiceRoleStrategy { }
class YarnResourceManagerStrategy implements ServiceRoleStrategy { }
class KafkaBrokerStrategy implements ServiceRoleStrategy { }
```

### 4.4 配置管理

**多层次配置**:
1. **框架级配置**: 定义在元数据 JSON 文件中
2. **集群级配置**: 集群级别的默认配置
3. **服务级配置**: 服务实例的配置
4. **角色级配置**: 服务角色的配置

**配置模板引擎**:
使用 FreeMarker 模板引擎动态生成配置文件：
```
hdfs-site.xml.ftl → hdfs-site.xml
core-site.xml.ftl → core-site.xml
```

### 4.5 监控架构

**监控数据流**:
```
服务进程 (HDFS/YARN/...)
   ↓ JMX/HTTP API
Prometheus Exporter
   ↓ HTTP
Prometheus Server
   ↓ PromQL
DataSophon API (查询)
   ↓ REST API
DataSophon UI (展示)
```

**集成方案**:
- JMX Exporter: Java 应用监控
- Node Exporter: 主机资源监控
- Process Exporter: 进程监控
- Custom Exporter: 自定义指标

## 五、数据流架构

### 5.1 命令执行流程

```
用户操作 (Web UI)
   ↓ HTTP POST
API Controller
   ↓ 调用
Service 层
   ↓ 发送消息
ClusterActor
   ↓ 构建 DAG
DAGBuildActor
   ↓ 任务分发
DispatcherWorkerActor
   ↓ Actor 消息
Worker 节点
   ↓ Shell 执行
服务进程
   ↓ 结果返回
ServiceExecuteResultActor
   ↓ 更新状态
数据库
   ↓ 推送通知
WebSocket
   ↓ 实时更新
Web UI
```

### 5.2 监控数据流程

```
服务进程 (JMX/API)
   ↓ 暴露指标
Prometheus Exporter
   ↓ 抓取 (Pull)
Prometheus Server
   ↓ 存储时序数据
TSDB
   ↓ PromQL 查询
DataSophon API
   ↓ REST API
Web UI (图表展示)
```

### 5.3 告警处理流程

```
Prometheus (告警规则)
   ↓ 触发告警
AlertManager
   ↓ 路由分组
DataSophon API
   ↓ 持久化
MySQL (告警历史)
   ↓ 通知
告警接收者 (邮件/短信/钉钉)
```

## 六、安全架构

### 6.1 认证机制

- **用户名密码认证**: 默认认证方式
- **LDAP 认证**: 企业级集成
- **Token 认证**: JWT Token

### 6.2 授权机制

- **基于角色的访问控制 (RBAC)**
- **资源级权限控制**
- **操作级权限控制**

### 6.3 数据安全

- **数据库连接加密**
- **密码加密存储**
- **HTTPS 传输**
- **Kerberos 集成** (用于大数据组件)

## 七、高可用设计

### 7.1 Master 高可用

- **主备模式**: 支持 Master 主备部署
- **状态同步**: 通过数据库共享状态
- **故障转移**: 自动故障检测和切换

### 7.2 数据持久化

- **MySQL 主从复制**
- **定期备份**
- **事务保证**

### 7.3 Worker 容错

- **心跳检测**: 定期检测 Worker 状态
- **任务重试**: 失败任务自动重试
- **故障隔离**: 单个 Worker 故障不影响其他节点

## 八、扩展性设计

### 8.1 水平扩展

- **无状态 API**: API 服务可水平扩展
- **Worker 动态添加**: 支持动态增加 Worker 节点
- **负载均衡**: 任务均匀分配到 Worker

### 8.2 插件化架构

- **服务插件**: 支持添加新的大数据组件
- **监控插件**: 支持自定义监控指标
- **告警插件**: 支持自定义告警方式

### 8.3 配置化管理

- **元数据驱动**: 通过 JSON 配置定义服务
- **版本管理**: 支持多版本配置
- **动态加载**: 配置变更无需重启

## 九、性能优化

### 9.1 缓存策略

- **本地缓存**: 缓存常用配置和状态
- **分布式缓存**: Redis 缓存集群数据
- **多级缓存**: 减少数据库访问

### 9.2 异步处理

- **Actor 异步**: 异步任务处理
- **线程池**: 合理配置线程池大小
- **消息队列**: 削峰填谷

### 9.3 数据库优化

- **索引优化**: 合理创建索引
- **查询优化**: 避免全表扫描
- **连接池**: 数据库连接池管理

## 十、技术选型理由

| 技术 | 用途 | 选型理由 |
|------|------|---------|
| Spring Boot | 应用框架 | 快速开发、自动配置、生态完善 |
| MyBatis | ORM | 灵活的 SQL 控制、性能好 |
| Vue.js | 前端框架 | 组件化、响应式、易学习 |
| Akka Actor | 分布式调度 | 异步消息、容错、位置透明 |
| Prometheus | 监控 | 时序数据库、强大的查询、社区活跃 |
| MySQL | 关系数据库 | 稳定可靠、支持事务、广泛使用 |
| Element UI | UI 组件库 | 组件丰富、文档完善、中文友好 |

---

**文档版本**: v1.0  
**最后更新**: 2025-11-15
